<!DOCTYPE html>

<html>                                                                
<head>
<title>LinkGame 0.1</title>
<!-- <link rel="stylesheet" href="/site_media/style.css"> -->
<link type="text/css" href="/trek/site_media/game.css" rel="Stylesheet" />	
<script type="text/javascript" src="/trek/site_media/jqueryui/js/jquery-1.4.2.min.js"></script>
<link type="text/css" href="/trek/site_media/jqueryui/css/ui-lightness/jquery-ui-1.8.custom.css" rel="Stylesheet" />	
<script type="text/javascript" src="/trek/site_media/jqueryui/js/jquery-ui-1.8.custom.min.js"></script>
<script type="text/javascript">


//Global Variables
var usedLinks = 0;
var points = 0;
var cnurl = "/api/en";



$(document).ready(function(){
	var startConcept = '{{ concept1 }}';
	var endConcept = '{{ concept2 }}';
	var cnetRelations = new Array();
        var cnetRelationsD = {};


	

	//Gets Relations
	{% for relationInfo in relationsList %}
	//$("#relationsMenu").append("<option value='{{ relationInfo.0 }}'>" + '{{
	//  relationInfo.1.1 }}' + "</option>");
  		cnetRelations.push('{{ relationInfo.1.0 }}')
	        cnetRelationsD['{{ relationInfo.1.0 }}'] = '{{ relationInfo.0 }}'
	{% endfor %}


	//jQuery UI
  	$('#linkButton').button();	
	$('#getConceptsButton').button();
  	$("#relationsMenu").autocomplete({source: cnetRelations, delay: 0});
  	$("#relationsMenuB").button({icons: { primary: "ui-icon-triangle-1-s"}, text: false});

	//Sets up AutoComplete button
  	$("#relationsMenuB").click(function() {
  					// close if already visible
					if ($("#relationsMenu").autocomplete("widget").is(":visible")){
   						$("#relationsMenu").autocomplete("close");
					}
					// pass empty string as value to search for, displaying all results
					$("#relationsMenu").autocomplete("search", " ");
					$("#relationsMenu").focus();
  					return false; //So that the form does not submit
					});

  
  	$("#relationsMenuB").position({ my: "left center", at: "right center", of: $("#relationsMenu"), offset: "-1 0"}).css("top", "").addClass("ui-corner-right ui-button-icon");
	$("#relationsMenuB").height($("#relationsMenu").height());
  
  
  	//Draws the first concept in the canvas
  	draw('{{ concept1 }}');




	$("#linkButton").click(function() {  
		// validate form here
		var concept1 = $("#concept1").text()
  		var concept2 = $("input#concept2").val();
  		var relation = $("input#relationsMenu").val();
  
 		if (concept1 == "") {
		  //Do something if concept1 is blank
		  //Maybe $("label#name_error").show();
		}

  		if (concept2 == "") {
  			//Do something if concept2 is blank
  		}

  		if (concept2 == endConcept) {
  			var str = "You found a connection! Thanks for your contribution.";
			$("#linkButton").button( "option", "disabled", true )
		} else {
  			var str = concept1 + " " + relation + " " + concept2 + "<br />"
  			$("#concept1").text(concept2)
  		}

	        var exists = assertionExists(cnetRelationsD[relation], concept1, concept2);
	  	addLink(str);
	  	draw(concept2);
		assignPoints(getPointValue());
  		$("#pointsVal").text(points);

  		return false;
	}); 



	function assignPoints(p) {
  		points = points + p;
  	}

  	function getPointValue() {
  		return 1;
  	}

  	function addLink(str) {
    	$("#linkslist").append(str);
    	usedLinks = usedLinks + 1;
    	$("#linksVal").text(usedLinks);
  	}


});
  
  
//Queries ConceptNet to see if link is there
//Returns true if it is, false if it isn't
function inCN(concept) {

	$.ajax({
		url: cnurl+'en/concept/'+concept+ '/',
		type: 'get',
		success: function(data, status, x) {
                        console.log("It was there");
			return true;
		},
		error: function() {
                        console.log("It wasn't there");
			return false;
		}
	});
};

function assertionExists(rel, concept1, concept2) {

      $.ajax({
           url:cnurl + '/assertionfind/' + rel + '/' + concept1 + '/'
+ concept2 + '/',
           type: 'get',
           success: function(data, status, x) {
               if (data == '[]') {
               		console.log("%s,%s,%s wasn't there", rel, concept1, concept2);
              
					return (false);
				}
               		console.log("%s,%s,%s was there", rel, concept1, concept2);              
               		
               		var assertion = eval(data);
               		console.log(data.concept1);
               		console.log("Assertion", assertion);
               		return (true);
        		}

});


}

  

</script>

  <script type="text/javascript">

  var lastx = (500 / 2);
  var lasty = 2.5;
  var drawArrow = false;
  
  function draw(str){
  var canvas = document.getElementById("canvas");
  var paddingW = 20;
  var paddingH = 20;
  var cvWidth = $("#canvas").width();

  if (canvas.getContext){  
  var ctx = canvas.getContext("2d");
  ctx.textAlign = "center";
  ctx.lineWidth = 1.0;
  ctx.textBaseline = "middle";
  ctx.font = "1em sans-serif";
  ctx.lineJoin = "round";
  //ctx.fillText('{{ concept1 }}', 60, 60);
  // ctx.beginPath();  
  // ctx.arc(75,75,50,0,Math.PI*2,true); // Outer circle  
  // ctx.stroke();   


  var metrics = ctx.measureText(str);
  var nodeWidth = metrics.width + paddingW;
  var nodeHeight = 30;

  if (drawArrow == true) {

  var arrowLength = lasty + 30;

  ctx.beginPath();
  ctx.moveTo(lastx, lasty);
  ctx.lineTo(lastx, arrowLength);
  ctx.lineTo(lastx + 5, arrowLength - 5);
  ctx.moveTo(lastx - 5, arrowLength - 5);
  ctx.lineTo(lastx, arrowLength);
  ctx.stroke();
  ctx.closePath();

  lasty = arrowLength + 6;

}

  draw_node(ctx, lastx-(nodeWidth/2), lasty, nodeWidth, nodeHeight);
  ctx.fillText(str, lastx+(nodeWidth/2)-(nodeWidth/2), lasty+(nodeHeight/2));
  lastx = lastx;
  lasty = lasty + nodeHeight;

drawArrow = true;
  } else {  
  // canvas-unsupported code here  
  }  }


  function draw_node(context, x, y, width, height) {
  context.strokeRect(x, y, width,  height );
  };
  </script>
</head>                                                                 

<body>                                                                  

<div class="title">
<h1>LinkGame 0.1</h1>
  </div>

<div class="nav">
<ul>

<li><a href="profile">Profile</a></li>
<li><a href="news.asp">Points: 50 </a></li>
<li><a href="default.asp">knt</a></li>
</ul>
</div>




<div id="visuals" class="visual">
  <canvas id="canvas" width="500" min-height="400">Visualizes your path in the game.</canvas>
</div>



<div id="userControls">
<div class="text">
  Try to find a connection between <span class="concept"> {{ concept1 }} </span> and <span class="concept">
  {{ concept2 }} </span>.
</div>

<div id="linkslist">

</div>

<div class="form">
  <form name="linkForm" id="linkForm" action="" method="" >
  <span class="concept" name="concept1" id="concept1">{{ concept1 }}</span>
  <!-- <select name="relation" id="relationsMenu" required="true">
  </select>-->
  <input type="text" name="relation" id="relationsMenu"
  required="true" />
  <button id="relationsMenuB" type=""></button>
  <input type="text" name="concept2" id="concept2" class="conceptBox" required="true" />
  <button name="submitButton" id="linkButton" type="submit">Submit</button>
  </form>
</div>

<button action="" method="" name="getConceptsButton"
id="getConceptsButton" type="submit">Get New Concepts</button>
<br />
<span class="text" name="numLinks" id="numLinks">You used <span
id="linksVal">0</span> links</span> <br />
<span class="text" name="points" id="points">You have <span
id="pointsVal">0</span> points. </span>

</div>

  
</body>                                                                 
</html>